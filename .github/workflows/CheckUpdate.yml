name: Check Management Index

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Configure SSH Access
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Fetch and Compare
        id: check
        run: |
          curl -sS -f https://prod-noticeindex.bluearchiveyostar.com/prod/index.json | jq -S . > /tmp/latest_cloud.json
          
          if [ -f "index.json" ]; then
            jq -S . index.json > /tmp/temp_local.json
            if diff -q /tmp/latest_cloud.json /tmp/temp_local.json > /dev/null; then
              echo "update_detected=false" >> $GITHUB_ENV
              exit 0
            fi
          fi
          
          echo "update_detected=true" >> $GITHUB_ENV
          mkdir -p prod
          cp /tmp/latest_cloud.json index.json
          cp /tmp/latest_cloud.json prod/index.json
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.json
          git commit -m "Sync: New index detected" || true
          git push origin HEAD

      - name: Run Translation
        if: env.update_detected == 'true'
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          BUVID3: ${{ secrets.BUVID3 }}
          BILI_JCT: ${{ secrets.BILI_JCT }}
          SESSDATA: ${{ secrets.SESSDATA }}
          PYTHONUNBUFFERED: "1"
        run: |
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          git clone --depth 1 git@github.com:bluearchive-cafe/bluearchive-cafe-prod-notice.git
          python -m pip install requests beautifulsoup4 openai tqdm boto3 xxhash
          cp -r tool/* . && rm -rf tool
          python -m translation.translation_announcement
          python -m update_notice_kv
          python -m bilibili.bilibili_column

      - name: Save Changes
        if: env.update_detected == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add prod/
          if ! git diff --cached --quiet; then
            git commit -m "Update: Translated results $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push origin HEAD
          fi

          cp -r prod/* bluearchive-cafe-prod-notice/public/prod/
          cd bluearchive-cafe-prod-notice
          git add public/prod/
          if ! git diff --cached --quiet; then
            git commit -m "Update: Translated results $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push origin HEAD
          fi
