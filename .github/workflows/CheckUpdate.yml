name: Check Management Index

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Fetch and Compare
        id: check
        run: |
          curl -sS -f https://prod-noticeindex.bluearchiveyostar.com/prod/index.json | jq -S . > latest_origin.json
          
          if [ -f "original_index.json" ]; then
            jq -S . original_index.json > temp_old.json
            if diff -q latest_origin.json temp_old.json > /dev/null; then
              echo "update_detected=false" >> $GITHUB_ENV
              exit 0
            fi
          fi
          
          echo "update_detected=true" >> $GITHUB_ENV
          cp latest_origin.json original_index.json
          mkdir -p prod
          cp latest_origin.json prod/index.json
          
          curl -X POST "https://web.archive.org/save/https://prod-noticeindex.bluearchiveyostar.com/prod/index.json" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "url=https://prod-noticeindex.bluearchiveyostar.com/prod/index.json" \
            --data-urlencode "capture_outlinks=on" > /dev/null || true

      - name: Run Translation
        if: env.update_detected == 'true'
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          git clone --depth 1 https://github.com/beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* . && rm -rf tool
          python -m pip install requests beautifulsoup4 openai tqdm boto3
          python -m tools.translation_announcement

      - name: Save Changes
        if: env.update_detected == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "Update: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push origin HEAD
          fi
